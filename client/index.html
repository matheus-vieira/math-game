<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <title>Test</title>
</head>

<body>
    <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
        <h5 class="my-0 mr-md-auto font-weight-normal">Math Game</h5>
    </div>
    <div class="px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <h1 class="display-4">Math Game</h1>
        <p class="lead">Hello person! Welcome to my math game, I hope you enjoy</p>
    </div>
    <div class="container">
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="col col-lg-12" id="wait">
                        <p class="mb-3 text-center">Wainting next round</p>
                    </div>
                    <div class="col col-lg-12 d-none" id="challenge">
                        <div class="card-deck mb-3 text-center">
                            <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <h1 class="card-title"><span id="operand-a">5</span></h1>
                                </div>
                            </div>
                            <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <h1 class="card-title"><span id="operation">*</span></h1>
                                </div>
                            </div>
                            <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <h1 class="card-title"><span id="operand-b">5</span></h1>
                                </div>
                            </div>
                            <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <h1 class="card-title">=</h1>
                                </div>
                            </div>
                            <div class="card mb-2 shadow-sm">
                                <div class="card-body">
                                    <h1 class="card-title"><span id="answer">30</span></h1>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center">
                            <form class="form-inline mx-auto">
                                <div class="form-group mb-2">
                                    <h1 class="form-group">Is the answer</h1>
                                </div>
                                <div class="form-group mx-sm-3 mb-2">
                                    <button type="button" id="btn-correct" class="btn btn-success btn-lg mb-2">Correct</button>
                                </div>
                                <div class="form-group mb-2">
                                    <h1 class="form-group">or</h1>
                                </div>
                                <div class="form-group mx-sm-3 mb-2">
                                    <button type="button" id="btn-wrong" class="btn btn-danger btn-lg mb-2">Wrong</button>
                                </div>
                                <div class="form-group mb-2">
                                    <h1 class="form-group">?</h1>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card-deck mb-3 text-center">
                    <div class="card mb-2 shadow-sm">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">
                                <span id="player-name"></span><i class="material-icons" data-toggle="modal" data-target="#new-name-modal">edit</i>                                        
                            </h4>
                            <span>Wins <span class="badge badge-success" id="player-wins">0</span></span>
                            <span>Lost <span class="badge badge-warning" id="player-lost">0</span></span>
                            <span>Score <span class="badge badge-info" id="player-score">0</span></span>
                        </div>
                        <div class="card-body">
                            <h1 class="card-title">Players (<small id="players-count" class="text-muted">0</small>)</h1>
                            <ul class="list-unstyled mt-3 mb-4" id="players-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div class="modal fade" id="new-name-modal" tabindex="-1" role="dialog" aria-labelledby="new-name-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="new-name-modal-label">Change your name</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body form-inline">
                        <label class="my-1 mr-2" for="txt-new-name">Name</label>
                        <input type="text" id="txt-new-name" required placeholder="Type your new name"/>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btn-new-name" data-dismiss="modal">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="pt-4 my-md-5 pt-md-5 border-top">
            <div class="row">
                <div class="col-12 col-md">
                    <img class="mb-2" src="https://matheus-vieira.github.io/images/author.png" alt="" width="48" height="48" />
                    <small class="d-block mb-3 text-muted">Â© 2017-2018</small>
                </div>
                <div class="col-6 col-md">
                    <h5>Server with node</h5>
                    <ul class="list-unstyled text-small">
                        <li><a class="text-muted" href="#">Express.IO</a></li>
                        <li><a class="text-muted" href="#">Socket.IO</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md">
                    <h5>Client</h5>
                    <ul class="list-unstyled text-small">
                        <li><a class="text-muted" href="#">Bootstrap</a></li>
                        <li><a class="text-muted" href="#">jQuery (as needed by bootstrap)</a></li>
                        <li><a class="text-muted" href="#">Pure JS</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md">
                    <h5>About</h5>
                    <ul class="list-unstyled text-small">
                        <li><a class="text-muted" href="#">Team</a></li>
                        <li><a class="text-muted" href="#">Locations</a></li>
                        <li><a class="text-muted" href="#">Privacy</a></li>
                        <li><a class="text-muted" href="#">Terms</a></li>
                    </ul>
                </div>
            </div>
        </footer>
    </div>
    <div id="hello"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script type="text/html" id="tpl-player">
        <li>
            <span class="badge">
                {name}
                <span class="badge badge-success">{wins}</span>
                <span class="badge badge-warning">{lost}</span>
                <span class="badge badge-info">{score}</span>
            </span>
        </li>
    </script>
    <script>
        (function (d) {
            const getTemplate = id => {
                let elem = d.getElementById(id);
                return elem ? elem.innerHTML : "";
            }
            /**
             * supplant() does variable substitution on the string. It scans through the string looking for
             * expressions enclosed in { } braces. If an expression is found, use it as a key on the object,
             * and if the key has a string value or number value, it is substituted for the bracket expression
             * and it repeats.
             *
             * Written by Douglas Crockford
             * http://www.crockford.com/
             */
            String.prototype.supplant = function (o) {
                return this.replace(/{([^{}]*)}/g, function (a, b) {
                    var type = typeof (o[b]);
                    if (type === "number" || type === "string")
                        return o[b];
                    var r = o[b] || (function () {
                        var r = o;
                        b.split(".").forEach(function (e) {
                            r = r[e] || r[e.toLowerCase()];
                        });
                        return r;
                    })();
                    return typeof r === 'string' || typeof r === 'number' ? r : a;
                });
            };
            function debounce(func, wait, immediate) {
                let timeout;
                return function() {
                    let context = this, args = arguments;
                    let later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    let callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };

            var socket = io();

            function playersChangedScope() {
                const tpl = getTemplate('tpl-player');
                const holder = d.getElementById('players-list');
                const countHolder = d.getElementById('players-count');
                return data => {
                    console.log('playersChanged', data);
                    holder.innerHTML = '';
                    data.players.forEach(p => {
                        holder.innerHTML += tpl.supplant(p)
                    });
                    countHolder.innerHTML = data.players.length;
                }
            }
            const onPlayersChanged = playersChangedScope();
            socket.on('playersChanged', onPlayersChanged);

            function scoreScope() {
                const nameHolder = d.getElementById('player-name');
                const winsHolder = d.getElementById('player-wins');
                const lostHolder = d.getElementById('player-lost');
                const scoreHolder = d.getElementById('player-score');
                return data => {
                    nameHolder.innerHTML = data.name;
                    winsHolder.innerHTML = data.wins;
                    lostHolder.innerHTML = data.lost;
                    scoreHolder.innerHTML = data.score;
                }
            }
            const onScore = scoreScope();
            socket.on('score', onScore);
            socket.on('addPlayer', onScore);

            function newChallengeScope() {
                const operandA = d.getElementById('operand-a');
                const operandB = d.getElementById('operand-b');
                const operation = d.getElementById('operation');
                const answer = d.getElementById('answer');
                const challenge = d.getElementById('challenge');
                const wait = d.getElementById('wait');
                return data => {
                    console.log('newChallenge', data);
                    wait.classList.remove("d-block");
                    wait.classList.add("d-none");

                    challenge.classList.remove("d-none");
                    challenge.classList.add("d-block");

                    operandA.innerHTML = data.operandA;
                    operandB.innerHTML = data.operandB;
                    operation.innerHTML = data.operation;
                    answer.innerHTML = data.answer;
                };
            }
            const onNewChallenge = newChallengeScope();
            socket.on('newChallenge', onNewChallenge);

            function nextChallengeScope() {
                const challenge = d.getElementById('challenge');
                const wait = d.getElementById('wait');
                return data => {
                    console.log('nextChallenge', data);
                    wait.classList.add("d-block");
                    wait.classList.remove("d-none");
                    challenge.classList.add("d-none");
                    challenge.classList.remove("d-block");
                    onPlayersChanged(data);
                };
            }
            socket.on('nextChallenge', nextChallengeScope());

            function setNameScope() {
                const name = d.getElementById('txt-new-name');
                return function (newName) {
                   socket.emit('nameChanged', { name: newName || name.value });
                }

            }
            const setName = setNameScope();

            // setting event listeners
            d.getElementById('btn-new-name')
                .addEventListener('click', debounce(() => setName(), 500));
            d.getElementById('btn-correct')
                .addEventListener('click', debounce(() => socket.emit('answer', { answer: true }), 500));
            d.getElementById('btn-wrong')
                .addEventListener('click', debounce(() => socket.emit('answer', { answer: false }), 500));
        })(document);
    </script>
</body>

</html>