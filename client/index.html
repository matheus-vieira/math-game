<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        #challenge {
            font-size: 200%;
        }
    </style>
    <title>Math Game</title>
</head>

<body>
    <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
        <h5 class="my-0 mr-md-auto font-weight-normal">Math Game</h5>
    </div>
    <div class="px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <h1 class="display-4">Math Game</h1>
        <p class="lead">Hello person! Welcome to my math game, I hope you enjoy</p>
    </div>
    <div class="container">
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="col">
                        <div class="row">
                            <div class="col col-lg-12" id="wait">
                                <p class="mb-3 text-center">Waiting next round</p>
                            </div>
                            <div class="col d-none " id="challenge">
                                <div class="row">
                                    <div class="mx-auto">
                                        <span class="badge mw-200" id="operand-a">4</span>
                                        <span class="badge mw-200" id="operation">4</span>
                                        <span class="badge mw-200" id="operand-b">4</span>
                                        <span class="badge mw-200" id="">=</span>
                                        <span class="badge mw-200" id="answer">4</span>
                                    </div>
                                </div>
                                <div class="row">
                                    <form class="form-inline mx-auto">
                                        <div class="form-group mb-2">
                                            <h1 class="form-group">Is the answer</h1>
                                        </div>
                                        <div class="form-group mx-sm-3 mb-2">
                                            <button type="button" id="btn-correct" class="btn btn-success btn-lg mb-2">Correct</button>
                                        </div>
                                        <div class="form-group mb-2">
                                            <h1 class="form-group">Or</h1>
                                        </div>
                                        <div class="form-group mx-sm-3 mb-2">
                                            <button type="button" id="btn-wrong" class="btn btn-danger btn-lg mb-2">Wrong</button>
                                        </div>
                                        <div class="form-group mb-2">
                                            <h1 class="form-group">?</h1>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card-deck mb-3 text-center">
                    <div class="card mb-2 shadow-sm">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">
                                <span id="player-name"></span><i class="material-icons" data-toggle="modal" data-target="#new-name-modal">edit</i>                                        
                            </h4>
                            <span>Wins <span class="badge badge-success" id="player-wins">0</span></span>
                            <span>Lost <span class="badge badge-warning" id="player-lost">0</span></span>
                            <span>Score <span class="badge badge-info" id="player-score">0</span></span>
                        </div>
                        <div class="card-body">
                            <h1 class="card-title">Players (<small id="players-count" class="text-muted">0</small>)</h1>
                            <ul class="list-unstyled mt-3 mb-4" id="players-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div class="modal fade" id="new-name-modal" tabindex="-1" role="dialog" aria-labelledby="new-name-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="new-name-modal-label">Change your name</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body form-inline">
                        <label class="my-1 mr-2" for="txt-new-name">Name</label>
                        <input type="text" id="txt-new-name" required placeholder="Type your new name"/>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btn-new-name" data-dismiss="modal">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="pt-4 my-md-5 pt-md-5 border-top">
            <div class="row">
                <div class="col-12 col-md">
                    <small class="d-block mb-3 text-muted">Â© 2017-2018</small>
                </div>
                <div class="col-6 col-md">
                    <h5>Server with node</h5>
                    <ul class="list-unstyled text-small">
                        <li><a class="text-muted" href="https://expressjs.com/">Express.IO</a></li>
                        <li><a class="text-muted" href="https://socket.io/">Socket.IO</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md">
                    <h5>Client</h5>
                    <ul class="list-unstyled text-small">
                        <li><a class="text-muted" href="https://getbootstrap.com/">Bootstrap</a></li>
                        <li><a class="text-muted" href="https://jquery.com/">jQuery (as needed by bootstrap)</a></li>
                        <li><a class="text-muted" href="https://vanilla-js.com/">Vanilla JS</a></li>
                        <li><a class="text-muted" href="https://socket.io/">Socket.IO</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md">
                    <h5>About</h5>
                    <ul class="list-unstyled text-small">
                        <li><a class="text-muted" href="https://matheus-vieira.github.io/">Matheus Costa Vieira</a></li>
                    </ul>
                </div>
            </div>
        </footer>
    </div>
    <div id="hello"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/0.9.90/jsrender.min.js" integrity="sha256-btLQj6RlkxXK4cg6XHngg3OVgPdiD3QlkaYMZacCmpA=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js" integrity="sha256-+nuEu243+6BveXk5N+Vbr268G+4FHjUOEcfKaBqfPbc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script id="tpl-player" type="text/x-jsrender">
        {{for players}}
        <li>
            <span class="badge">
                {{:name}}
                <span class="badge badge-success">{{:wins}}</span>
                <span class="badge badge-warning">{{:lost}}</span>
                <span class="badge badge-info">{{:score}}</span>
            </span>
        </li>
        {{/for}}
    </script>
    <script>
        (function (d) {
            let socket = (() => {
                let socket = io();

                function on(event, callback) {
                    socket.on(event, callback);
                }
                function emit(event, data) {
                    socket.on(event, data || {});
                }
                return {
                    on: on,
                    emit: emit
                }
            })();

            socket.on('disconnect', () => console.log("disconnected"));

            function playersChangedScope() {
                const $tpl = $('#tpl-player');
                const $holder = $('#players-list');
                const $countHolder = $('#players-count');
                return data => {
                    $countHolder.html(data.players.length);
                    $holder.html($tpl.render(data));
                }
            }
            const onPlayersChanged = playersChangedScope();
            socket.on('playersChanged', onPlayersChanged);

            function scoreScope() {
                const $nameHolder = $('#player-name');
                const $winsHolder = $('#player-wins');
                const $lostHolder = $('#player-lost');
                const $scoreHolder = $('#player-score');
                return data => {
                    $nameHolder.html(data.name);
                    $winsHolder.html(data.wins);
                    $lostHolder.html(data.lost);
                    $scoreHolder.html(data.score);
                }
            }
            const onScore = scoreScope();
            socket.on('score', onScore);
            socket.on('addPlayer', onScore);

            function newChallengeScope() {
                const $operandA = $('#operand-a');
                const $operandB = $('#operand-b');
                const $operation = $('#operation');
                const $answer = $('#answer');
                const $challenge = $('#challenge');
                const $wait = $('#wait');
                return data => {
                    $wait.removeClass("d-block").addClass("d-none");
                    $challenge.removeClass("d-none").addClass("d-block");

                    $operandA.html(data.operandA);
                    $operandB.html(data.operandB);
                    $operation.html(data.operation);
                    $answer.html(data.answer);
                };
            }
            const onNewChallenge = newChallengeScope();
            socket.on('newChallenge', onNewChallenge);

            function nextChallengeScope() {
                const $challenge = $('#challenge');
                const $wait = $('#wait');
                return data => {
                    $wait.addClass("d-block").removeClass("d-none");
                    $challenge.addClass("d-none").removeClass("d-block");
                    onPlayersChanged(data);
                };
            }
            socket.on('nextChallenge', nextChallengeScope());

            function roomfullScope() {
                const $pWait = $('#wait > p');
                return data => $pWait.html(data.msg);
            }
            socket.on('roomfull', roomfullScope());

            function setNameScope() {
                const name = d.getElementById('txt-new-name');
                return function (newName) {
                   socket.emit('nameChanged', { name: newName || name.value });
                }

            }
            const setName = setNameScope();


            // setting event listeners
            $('btn-new-name').click($.debounce(500, () => setName()));
            $('btn-correct').click($.debounce(500, () => socket.emit('answer', { answer: true })));
            $('btn-wrong').click($.debounce(500, () => socket.emit('answer', { answer: false })));
        })(document);
    </script>
</body>

</html>